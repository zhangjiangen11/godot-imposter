[gd_scene load_steps=4 format=3 uid="uid://b6601b4wn2mri"]

[ext_resource type="Script" path="res://addons/Imposter/imposter/scripts/dilatate.gd" id="1_isphw"]

[sub_resource type="Shader" id="Shader_o6sob"]
code = "shader_type canvas_item;
render_mode blend_premul_alpha;

uniform sampler2D u_alpha_tex;
uniform int u_distance = 16;
uniform bool u_alpha_overwrite = true;


vec4 dilate(sampler2D a_tex, sampler2D tex, vec2 coords, vec2 texel_size, int dist, float alpha_cutoff)
{
	//alpha texture, texture, uv coordinates, texture pixel size, dilation pixel distance, dilation calculation threshold
	
	//dilation offset vertices
	vec2 offsets[8] = {
		vec2(-1,0),vec2(1,0), vec2(0,1), vec2(0,-1), 
		vec2(-1,1), vec2(1,1), vec2(1,-1), vec2(-1,-1)
	};
	//texture sampling, 0 represents the lowest precision texture sampling
	vec4 sample = textureLod(tex, coords, 0);
	vec4 a_sample = textureLod(a_tex, coords, 0);
	//check if the alpha transparency channel of the texture to be dilated is greater than the threshold, 1 is opaque, 0 is transparent. If completely opaque, return directly.
	if(a_sample.a > alpha_cutoff)
		return sample;
	//from 0 to the diffusion distance set by diffusion, each unit distance needs to calculate 8 dilation points
	for(int curr_dist = 0; curr_dist < dist; curr_dist++)
	{
		for(int o = 0; o < 8; o++)
		{
			vec2 off_coords = offsets[o] * texel_size * float(curr_dist + 1);
			vec4 off_sample = textureLod(tex, coords + off_coords, 0);
			vec4 off_a_sample = textureLod(a_tex, coords + off_coords, 0);
			//if the alpha texture of the diffused point is not completely opaque, do not process
			if (off_a_sample.a > alpha_cutoff)
			{
				if(u_alpha_overwrite)
					return off_sample;
				else
					//viewport will lose alpha rgb if alpha is below 0.5
					//at alpha transparent positions, sample points in 8 surrounding directions, if opaque texture can be collected from alpha map, set transparent position to this texture
					//create edge dilation effect
					
					return vec4(off_sample.rgb, a_sample.a);
			}
			
		}
	}
	return sample;
}

void fragment() {
	//alpha texture, texture, uv coordinates, texture pixel size, dilation pixel distance, dilation calculation threshold
    COLOR = dilate(u_alpha_tex, TEXTURE, UV, TEXTURE_PIXEL_SIZE, u_distance, 0.95);
	//COLOR.a = 1.0;
}
"

[sub_resource type="ShaderMaterial" id="ShaderMaterial_qdqnj"]
shader = SubResource("Shader_o6sob")
shader_parameter/u_distance = 32
shader_parameter/u_alpha_overwrite = false

[node name="Dilatate" type="Node2D"]
script = ExtResource("1_isphw")

[node name="DilateViewport" type="SubViewport" parent="."]
transparent_bg = true
handle_input_locally = false
size = Vector2i(1024, 1024)
size_2d_override = Vector2i(1024, 0)
render_target_update_mode = 4

[node name="tex" type="TextureRect" parent="DilateViewport"]
material = SubResource("ShaderMaterial_qdqnj")
custom_minimum_size = Vector2(4096, 4096)
offset_right = 4096.0
offset_bottom = 4096.0
stretch_mode = 2
